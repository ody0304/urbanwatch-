<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>URBANWATCH - Detalle del Reporte</title>
  <link rel="stylesheet" href="detalle-reporte-style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="logo.png" alt="Logo URBANWATCH" class="logo">
      <h1>URBANWATCH</h1>
    </div>
  </header>

  <main>
    <div class="reporte-banner">
      <h2 id="reporte-id">Reporte</h2>
    </div>

    <div class="reporte-contenido">
      <!-- Información general -->
      <div class="reporte-info">
        <h3 id="reporte-titulo">Título del reporte</h3>
        <div class="info-detalle" id="info-detalle"></div>
        <div class="reporte-imagen">
          <img src="imagen-placeholder.jpg" alt="Imagen del reporte" id="reporte-img">
          <!-- BOTÓN “Ver en mapa” eliminado -->
        </div>
      </div>

      <!-- Timeline de estado -->
      <div class="timeline">
        <h3>Estado del Reporte</h3>
        <div class="timeline-container" id="timeline-container"></div>
      </div>

      <!-- Sección de comentarios -->
      <div class="comentarios-seccion">
        <h3>Comentarios Ciudadanos</h3>
        <div class="comentarios-lista" id="comentarios-lista"></div>

        <button id="btn-comentario" class="btn-comentario">
          <i class="fas fa-comment-alt"></i> Añadir Comentario
        </button>

        <div class="comentario-info">
          <p>
            <i class="fas fa-info-circle"></i>
            Solo ciudadanos pueden añadir comentarios. No hay respuestas oficiales en esta plataforma.
          </p>
        </div>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 URBANWATCH - Plataforma Ciudadana</p>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    if (!id || isNaN(id)) {
      alert('ID de reporte inválido o no proporcionado.');
      return location.href = 'consultar.html';
    }

    try {
      // 1) Carga de datos en paralelo
      const [reporteRes, estadosRes, comentariosRes] = await Promise.all([
        fetch(`/api/reporte-info/${id}`),
        fetch(`/api/estado-reporte/${id}`),
        fetch(`/api/comentarios/${id}`)
      ]);

      if (!reporteRes.ok) {
        const txt = await reporteRes.text();
        alert(`Error ${reporteRes.status}: ${txt}`);
        return;
      }

      // 2) Parseo de JSON
      const reporte   = await reporteRes.json();
      const estados   = await estadosRes.json();
      let comentarios = await comentariosRes.json();

      // 3) Detecta roles desde localStorage
      const empleadoData    = localStorage.getItem('empleadoData');
      const correoCiudadano = localStorage.getItem('correoCiudadano');
      const correoAutor     = reporte.CorreoCiudadano;
      const anonimatoActivo = reporte.EsAnonimo === 1;

      // **DEBUG**: verifica que estás leyendo bien del localStorage
      console.log('DEBUG ▶ empleadoData:', empleadoData);
      console.log('DEBUG ▶ correoCiudadano:', correoCiudadano);

      // 4) Renderiza encabezado e info general
      document.getElementById('reporte-id').textContent      = `Reporte #${id}`;
      document.getElementById('reporte-titulo').textContent = reporte.Titulo || 'Sin título';
      document.getElementById('info-detalle').innerHTML = `
        <p><strong>Categoría:</strong> ${reporte.Categoria}</p>
        <p><strong>Ubicación:</strong> ${reporte.Direccion}</p>
        <span class="estado-badge">
          ${estados[estados.length - 1]?.Estado || 'Pendiente'}
        </span>
      `;

      // 5) Renderiza imagen si existe
      const imgTag = document.getElementById('reporte-img');
      if (reporte.Imagen1?.startsWith('data:image')) {
        imgTag.src = reporte.Imagen1;
      } else {
        imgTag.style.display = 'none';
      }

      // 6) Renderiza timeline
      const tlc = document.getElementById('timeline-container');
      tlc.innerHTML = '';
      estados.forEach((e, i) => {
        const cls = i === estados.length - 1 ? 'actual' : 'completo';
        tlc.innerHTML += `
          <div class="timeline-item ${cls}">
            <div class="timeline-icon"><i class="fas fa-clock"></i></div>
            <div class="timeline-content">
              <h4>${e.Estado}</h4>
              <p class="timeline-date">${new Date(e.Fecha).toLocaleString()}</p>
            </div>
          </div>`;
      });

      // 7) Renderiza comentarios existentes
      const lista = document.getElementById('comentarios-lista');
      function renderComentarios(arr) {
        lista.innerHTML = arr.map(c => {
          let quien;
          if (empleadoData) {
            // Empleado: siempre Anónimo
            quien = 'Anónimo';
          } else {
            // Ciudadano: respeta anonimato si aplica
            quien = (anonimatoActivo && c.CorreoCiudadano === correoAutor)
              ? 'Anónimo'
              : c.CorreoCiudadano;
          }
          return `
            <div class="comentario">
              <div class="comentario-header">
                <span class="usuario"><i class="fas fa-user"></i> ${quien}</span>
                <span class="fecha">${new Date(c.FechaComentario).toLocaleString()}</span>
              </div>
              <p>${c.Comentario}</p>
            </div>`;
        }).join('');
      }
      renderComentarios(comentarios);

      // 8) Control del botón “Añadir Comentario”
      const btn  = document.getElementById('btn-comentario');
      const info = document.querySelector('.comentario-info');

      if (empleadoData) {
        // Si es empleado → ocultar sección de comentarios
        btn.style.display  = 'none';
        info.style.display = 'none';

      } else if (correoCiudadano) {
        // Si es ciudadano autenticado → mostrar y habilitar
        btn.style.display  = 'inline-block';
        info.style.display = 'block';
        btn.addEventListener('click', async () => {
          const texto = prompt('Escribe tu comentario:');
          if (!texto) return;
          const resp = await fetch('/api/comentarios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              idReporte: id,
              correoCiudadano,
              comentario: texto
            })
          });
          if (resp.ok) {
            comentarios.push({
              CorreoCiudadano: correoCiudadano,
              Comentario: texto,
              FechaComentario: new Date().toISOString()
            });
            renderComentarios(comentarios);
          } else {
            alert('Error al guardar tu comentario.');
          }
        });

      } else {
        // Si no hay sesión → ocultar y redirigir al login
        btn.style.display  = 'none';
        info.style.display = 'none';
        alert('Debes iniciar sesión para ver y añadir comentarios.');
        location.href = 'login-ciudadano.html';
      }

    } catch (err) {
      console.error(err);
      alert('Hubo un problema al obtener la información del reporte.');
      location.href = 'consultar.html';
    }
  });
  </script>
</body>
</html>
