<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>URBANWATCH - Detalle del Reporte</title>
  <link rel="stylesheet" href="detalle-reporte-style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="logo.png" alt="Logo URBANWATCH" class="logo">
      <h1>URBANWATCH</h1>
    </div>
  </header>

  <main>
    <div class="reporte-banner">
      <h2 id="reporte-id">Reporte</h2>
    </div>

    <div class="reporte-contenido">
      <!-- Info general -->
      <div class="reporte-info">
        <h3 id="reporte-titulo">Título del reporte</h3>
        <div class="info-detalle" id="info-detalle"></div>
        <div class="reporte-imagen">
          <img src="imagen-placeholder.jpg" alt="Imagen del reporte" id="reporte-img">
        </div>
      </div>

      <!-- Timeline -->
      <div class="timeline">
        <h3>Estado del Reporte</h3>
        <div class="timeline-container" id="timeline-container"></div>
      </div>

      <!-- Comentarios (¡visible para todos!) -->
      <div class="comentarios-seccion">
        <h3>Comentarios Ciudadanos</h3>
        <div class="comentarios-lista" id="comentarios-lista"></div>

        <button id="btn-comentario" class="btn-comentario">
          <i class="fas fa-comment-alt"></i> Añadir Comentario
        </button>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 URBANWATCH - Plataforma Ciudadana</p>
  </footer>

  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    const params = new URLSearchParams(location.search);
    const id     = params.get('id');
    if (!id || isNaN(id)) {
      alert('ID de reporte inválido.');
      return location.href = 'consultar.html';
    }

    // 1) Cargar reporte, estado y comentarios
    const [repR, estR, comR] = await Promise.all([
      fetch(`/api/reporte-info/${id}`),
      fetch(`/api/estado-reporte/${id}`),
      fetch(`/api/comentarios/${id}`)
    ]);
    const reporte   = await repR.json();
    const estados   = await estR.json();
    let comentarios = await comR.json();

    // 2) Render info general
    document.getElementById('reporte-id').textContent      = `Reporte #${id}`;
    document.getElementById('reporte-titulo').textContent = reporte.Titulo || 'Sin título';
    document.getElementById('info-detalle').innerHTML = `
      <p><strong>Categoría:</strong> ${reporte.Categoria}</p>
      <p><strong>Ubicación:</strong> ${reporte.Direccion}</p>
      <span class="estado-badge">
        ${estados[estados.length - 1]?.Estado || 'Pendiente'}
      </span>
    `;
    // imagen
    const img = document.getElementById('reporte-img');
    if (reporte.Imagen1?.startsWith('data:image')) img.src = reporte.Imagen1;
    else img.style.display = 'none';

    // 3) Render timeline
    const tlc = document.getElementById('timeline-container');
    tlc.innerHTML = estados.map((e,i) => {
      const cls = i === estados.length - 1 ? 'actual' : 'completo';
      return `
        <div class="timeline-item ${cls}">
          <div class="timeline-icon"><i class="fas fa-clock"></i></div>
          <div class="timeline-content">
            <h4>${e.Estado}</h4>
            <p class="timeline-date">${new Date(e.Fecha).toLocaleString()}</p>
          </div>
        </div>`;
    }).join('');

    // 4) Render comentarios
    const lista = document.getElementById('comentarios-lista');
    function renderComentarios(arr) {
      lista.innerHTML = arr.map(c => `
        <div class="comentario">
          <div class="comentario-header">
            <span class="usuario"><i class="fas fa-user"></i> ${c.CorreoCiudadano}</span>
            <span class="fecha">${new Date(c.FechaComentario).toLocaleString()}</span>
          </div>
          <p>${c.Comentario}</p>
        </div>
      `).join('');
    }
    renderComentarios(comentarios);

    // 5) Botón de comentario (siempre visible)
    document.getElementById('btn-comentario').addEventListener('click', async () => {
      const correo = prompt('Tu correo electrónico:');
      const texto  = prompt('Escribe tu comentario:');
      if (!correo || !texto) return alert('Correo y comentario requeridos.');

      const resp = await fetch('/api/comentarios', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ idReporte: id, correoCiudadano: correo, comentario: texto })
      });
      if (resp.ok) {
        comentarios.push({ CorreoCiudadano: correo, Comentario: texto, FechaComentario: new Date().toISOString() });
        renderComentarios(comentarios);
      } else {
        alert('Error al enviar tu comentario.');
      }
    });
  });
  </script>
</body>
</html>

